<!DOCTYPE html>
<html lang="pt-BR">
<head th:replace="~{fragments/header :: header}"/>
<body>
<div class="container py-4">
    <div class="row">

        <div th:replace="~{fragments/sidebar :: sidebar}"/>

        <!-- Main Content -->
        <div class="col-md-9">
            <div class="container my-4">
                <h3 class="mb-4" style="color: #ff69b4;">Detalhes do Carrinho</h3>
                <div id="cart-tables"></div>
            </div>

            <!-- Thank You Section -->
            <div th:replace="~{fragments/footer :: footer}"/>

        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const cart = getCart();
    const cartTables = document.getElementById('cart-tables');

    cart.forEach(package => {
        const tableContainer = document.createElement('div');
        tableContainer.classList.add('card', 'border-0', 'shadow-sm', 'mb-4');
        tableContainer.style.backgroundColor = '#fff8f8';

        const tableHeader = `
            <div class="card-body">
                <h4 class="card-title mb-4" style="color: #ff69b4;">${package.packageName} - ${package.packageAmount}</h4>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr style="background-color: #ffecf2;">
                                <th scope="col">Donut</th>
                                <th scope="col">Quantidade</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                        <tfoot>
                            <tr class="fw-bold" style="background-color: #ffecf2;">
                                <td colspan="1" class="text-end">Subtotal:</td>
                                <td id="total-${package.packageId}">R$ 0,00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        `;

        tableContainer.innerHTML = tableHeader;
        cartTables.appendChild(tableContainer);

        const tableBody = tableContainer.querySelector('tbody');
        let packageTotal = 0;

        package.donuts.forEach(donut => {
            fetch(`/api/donuts/${donut.id}`)
                .then(response => response.json())
                .then(data => {
                    const row = document.createElement('tr');
                    const subtotal = 8 * donut.amount;
                    packageTotal += subtotal;
                    row.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="${data.imageUrl}" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                <div>
                                    <div class="fw-bold" style="color: #ff69b4;">${data.name}</div>
                                </div>
                            </div>
                        </td>
                        <td>${donut.amount}</td>
                    `;
                    tableBody.appendChild(row);
                    document.getElementById(`total-${package.packageId}`).textContent = `R$ ${packageTotal},00`;
                });
        });
    });
});

function getCart() {
    return JSON.parse(localStorage.getItem('cart')) || [];
}
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>